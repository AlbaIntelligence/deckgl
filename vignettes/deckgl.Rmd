---
title: "Introduction to deckgl for R "
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{deckgl}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r echo = FALSE}
example <- paste0(
  rprojroot::find_package_root_file(),
  "/inst/examples/deckgl-api-reference/hexagon-layer.R"
)
knitr::read_chunk(example)
```

Deckgl for R makes the open-source JavaScript library [deck.gl](https://deck.gl/) available within R via the [htmlwidgets](https://www.htmlwidgets.org/) package. 

## Quickstart

Create a `deckgl` widget:

```{r widget, eval = FALSE}
deck <- deckgl()
```

Add a base map from [mapbox](https://www.mapbox.com/) (optional):

```{r basemap, eval = FALSE}
Sys.setenv(MAPBOX_API_TOKEN = "yourSuperSecretApiToken")

deck <- deckgl() %>%
  add_mapbox_basemap(style = "mapbox://styles/mapbox/dark-v9")
```

Add any kind of layers:

```{r hexagon-layer, eval = FALSE}
```

## Examples

...

## The deckgl widget

This is where it all begins. To create a deckgl widget you call the `deckgl` function.
The widget takes mainly view port parameters and layers, which are added via the `add_*_layer` functions (see below).

Create a deckgl widget with 2 layers and `latLng(37.8, -122.45)` as initial view state: 

```{r deckgl-widget, eval = FALSE}
deck <- deckgl(latitude = 37.8, longitude = -122.45) %>%
  add_polygon_layer(data = polygon_data, properties = polygon_properties) %>%
  add_text_layer(data = text_data, properties = text_properties)
```

## Layers

Due to the generic function `add_layer` any kind of layer defined in the [deckgl-api-reference](https://deck.gl/#/documentation/deckgl-api-reference) is supported. The type of layer is chosen via the `class_name` parameter, e. g. `ScatterplotLayer` or `GeoJsonLayer`. Usually you will not use the generic function but one of the `add_*_layer` shortcut functions instead:

```{r add-layers-generic-vs-shortcut, eval = FALSE}
# Generic function
deckgl() %>% add_layer("ArcLayer", "arc-layer", data, properties)

# Shortcut function
deckgl() %>% add_arc_layer("arc-layer", data, properties)
```

All `add_*_layer` functions expect 3 arguments beside the deckgl widget itself: 

* `id`: unique id of the layer
* `data`: data to be rendered, either an url to fetch data from or a data object
* `properties`: named list of properties with names corresponding to the properties defined in the [deckgl-api-reference](http://deck.gl/#/documentation/deckgl-api-reference/) for the given layer class

## Data

### Data url

```{r data-url, eval = FALSE}
data_url <- paste0(
  "https://raw.githubusercontent.com/",
  "uber-common/deck.gl-data/",
  "master/website/sf-bike-parking.json"
)

deckgl() %>%
  add_grid_layer(data = data_url, properties = properties)
```

### Data object

```{r data-object, eval = FALSE}
deckgl() %>%
  add_scatterplot_layer(
    data = geojsonio::canada_cities,
    properties = properties
  )
```

### Data file

Furthermore it is possible to pass data as an external file (EXPERIMENTAL):

```{r data-file, eval = FALSE}
var_name <- "canadaCities"

deckgl() %>%
  add_data(geojsonio::canada_cities, var_name) %>%
  add_icon_layer(
    data = get_data(var_name),
    properties = properties
  )
```

## Properties

The `properties` parameter is a named list. The names correspond to the properties defined
in the [deckgl-api-reference](http://deck.gl/#/documentation/deckgl-api-reference/) for the given layer class and the properties inherited from the [base layer](http://deck.gl/#/documentation/deckgl-api-reference/layers/layer) class. 

In case a property is a data accessor / function, just use the `JS` function in R or one of the helper functions like `get_position` or `get_property` to pass it to the layer object.

### Properties example

JavaScript [api-reference-grid-layer](http://deck.gl/#/documentation/deckgl-api-reference/layers/grid-layer):

```javascript
const layer = new GridLayer({
  id: 'grid-layer',
  data,
  // properties to be defined in the 'properties' parameter in R
  pickable: true,
  extruded: true,
  cellSize: 200,
  elevationScale: 4,
  getPosition: d => d.COORDINATES
});
```

Corresponding `properties` parameter in R:

```{r properties, eval = FALSE}
properties <- list(
  pickable = TRUE,
  extruded = TRUE,
  cellSize = 200,
  evaluationScale = 4,
  getPosition = JS("d => d.COORDINATES")
)

# 'id' and 'data' properties are passed as first 2 arguments to 'add_*_layer'
deckgl() %>%
  add_grid_layer(
    id = "grid-layer",
    data = data,
    properties = properties
  )
```

Furthermore, it is possible to pass the properties directly to the `add_*_layer` functions via the `...` parameter. In case the `properties` parameter is also set, the `...` properties are added. Same properties are overwritten by the `...` properties.

Example for passing properties directly to `add_grid_layer`: 

```{r dots-properties}
deckgl() %>%
  add_grid_layer(
    id = "grid-layer",
    data = data,
    pickable = TRUE,
    extruded = TRUE,
    cellSize = 200,
    evaluationScale = 4,
    getPosition = JS("d => d.COORDINATES")
  )
```

### Data accessors

... 

## Tooltips

Additionally to the base properties defined in the [deckgl-api-reference](http://deck.gl/#/documentation/deckgl-api-reference/layers/layer) there is a `getTooltip` property showing a tooltip when the mouse enters an object. This property implements the `onHover` property and sets `pickable = true` for the given layer:

```{r tooltips eval = FALSE}
properties <- list(
  getTooltip = JS("object => object.name"),
  fixedTooltip = TRUE, # show tooltip always on upper left corner
  ...
  )
```

Available object properties depend on the layer you use. For example properties for the `GeoJsonLayer` can be accessed via `object.properties.<property>`.

## Icons

Icons are added via `add_icon_layer`. The following properties are used to define
the icon(s) to be displayed for each object:

* `iconAtlas`: atlas image (url or texture, see `encode_icon_atlas`)
* `iconMapping`: list with icon names mapped to icon definitions on the atlas image (see `icon_definition`)
* `getIcon`: method called to retrieve the icon name of each object

If not set, these properties are set via `default_icon_properties`.

## Colors

Layers in `deckgljs` usually expect colors to be rgb color arrays. `HexColor` values are supported though the `get_color_to_rgb_array` function (data accessor):

```{r colors, eval = FALSE}
sample_data <- bart_stations
sample_data$color <- rgb(sqrt(sample_data$exits), 140, 0, maxColorValue = 255)

deckgl() %>%
  add_icon_layer(
    data = sample_data,
    getPosition = get_position("lat", "lng"),
    getColor = get_color_to_rgb_array("color"),
  ) %>%
  add_mapbox_basemap()
```
